<div class="map-container">
  <div class="map-header">
    <button *ngIf="selectedActif" mat-raised-button color="primary" (click)="goBackToList()" matTooltip="Retour à la liste des actifs">
      <mat-icon>arrow_back</mat-icon>
      Retour à la liste
    </button>
    <h2>Cartographie des Actifs Portuaires</h2>
    <div class="map-controls">
      <button *ngIf="!selectedActif" mat-raised-button [color]="isFilterPanelVisible ? 'primary' : 'basic'" (click)="toggleFilterPanel()" matTooltip="Afficher/Masquer les filtres">
        <mat-icon>filter_list</mat-icon>
        Filtres
      </button>
      <button mat-raised-button [color]="isLegendVisible ? 'accent' : 'basic'" (click)="toggleLegend()" matTooltip="Afficher/Masquer la légende">
        <mat-icon>legend_toggle</mat-icon>
        Légende
      </button>
      <button mat-raised-button color="primary" (click)="centerOnTanger()" matTooltip="Centrer sur Tanger">
        <mat-icon>my_location</mat-icon>
        Le port
      </button>
      <button mat-raised-button color="accent" (click)="zoomToActifs()" [disabled]="isLoading" matTooltip="Voir tous les actifs">
        <mat-icon>zoom_out_map</mat-icon>
        Voir tout
      </button>
      <button mat-raised-button (click)="refreshData()" [disabled]="isLoading" matTooltip="Actualiser les données">
        <mat-icon [class.rotating]="isLoading">refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <div class="map-wrapper">
    <div id="map" class="ol-map" [class.loading]="isLoading"></div>
    <div #popup class="ol-popup">
      <a href="#" class="ol-popup-closer"></a>
      <div #popupContent></div>
    </div>
    <div *ngIf="isLoading" class="map-loading">
      <app-loading-spinner message="Chargement de la carte..."></app-loading-spinner>
    </div>
    <div *ngIf="error" class="map-error">
      <mat-icon>error</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="refreshData()">Réessayer</button>
    </div>

    <div *ngIf="isFilterPanelVisible && !selectedActif" class="floating-panel floating-filter-panel" cdkDrag cdkDragBoundary=".map-wrapper" cdkDragRootElement=".floating-filter-panel">
      <div class="panel-header" cdkDragHandle>
        <div class="panel-title">
            <mat-icon>filter_list</mat-icon>
            <h4>Filtres</h4>
        </div>
        <div class="panel-actions">
            <button mat-icon-button (click)="isFilterPanelContentVisible = !isFilterPanelContentVisible" matTooltip="Réduire/Agrandir">
                <mat-icon>{{ isFilterPanelContentVisible ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}</mat-icon>
            </button>
            <button mat-icon-button (click)="toggleFilterPanel()" matTooltip="Fermer">
                <mat-icon>close</mat-icon>
            </button>
        </div>
      </div>
      <div class="panel-content" *ngIf="isFilterPanelContentVisible">
        <div class="filter-section">
            <label>Fond de carte:</label>
            <mat-form-field appearance="fill" class="w-100">
                <mat-select [value]="selectedBaseMap" (selectionChange)="onBaseMapChange($event)">
                    <mat-option value="osm">OpenStreetMap</mat-option>
                    <mat-option value="satellite">Satellite</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="filter-section">
            <label>État des actifs:</label>
            <mat-chip-listbox multiple="true" aria-label="État selection">
                <mat-chip-option *ngFor="let chip of etatChips" [selected]="chip.selected" (click)="chip.selected = !chip.selected; applyFilters()" [style.background]="chip.selected ? chip.color : 'white'" [style.color]="chip.selected ? 'white' : chip.color">
                    {{ chip.label }} ({{ chip.count }})
                </mat-chip-option>
            </mat-chip-listbox>
        </div>

        <mat-accordion>
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>Sites</mat-panel-title>
                </mat-expansion-panel-header>
                <div class="filter-checkbox-list">
                    <mat-checkbox *ngFor="let filter of siteFilters" [(ngModel)]="filter.checked" (change)="applyFilters()">
                        {{ filter.label }} ({{ filter.count }})
                    </mat-checkbox>
                </div>
            </mat-expansion-panel>
            <mat-expansion-panel>
                <mat-expansion-panel-header>
                    <mat-panel-title>Zones</mat-panel-title>
                </mat-expansion-panel-header>
                 <div class="filter-checkbox-list">
                    <mat-checkbox *ngFor="let filter of zoneFilters" [(ngModel)]="filter.checked" (change)="applyFilters()">
                        {{ filter.label }} ({{ filter.count }})
                    </mat-checkbox>
                </div>
            </mat-expansion-panel>
        </mat-accordion>
        
        <div class="filter-actions">
            <button mat-stroked-button (click)="resetAllFilters()">Réinitialiser</button>
            <button mat-flat-button color="primary" (click)="applyFilters()">Appliquer</button>
        </div>
      </div>
    </div>

    <div *ngIf="isLegendVisible" class="floating-panel floating-legend-panel" cdkDrag cdkDragBoundary=".map-wrapper" cdkDragRootElement=".floating-legend-panel">
        <div class="panel-header" cdkDragHandle>
            <div class="panel-title">
                <mat-icon>legend_toggle</mat-icon>
                <h4>Légende</h4>
            </div>
            <div class="panel-actions">
                <button mat-icon-button (click)="toggleLegend()" matTooltip="Fermer">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
        <div class="panel-content">
            <div *ngIf="selectedActif" class="selected-actif-info">
                <strong>{{ selectedActif.nom }}</strong>
                <small>{{ selectedActif.code }}</small>
            </div>
            <div class="legend-items">
                <div class="legend-item" *ngFor="let chip of etatChips">
                    <div class="legend-symbol" [style.backgroundColor]="chip.color"></div>
                    <span>{{ chip.label }}</span>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>