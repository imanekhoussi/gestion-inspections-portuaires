<div class="map-container">
  <div class="map-header">
    <!-- Back button for single actif view -->
    <button *ngIf="selectedActif" 
            mat-raised-button 
            color="primary" 
            (click)="goBackToList()"
            matTooltip="Retour Ã  la liste des actifs">
      <mat-icon>arrow_back</mat-icon>
      Retour Ã  la liste
    </button>
    
    <h2>Cartographie des Actifs Portuaires</h2>
    
    <!-- Control buttons -->
    <div class="map-controls">
      <!-- Toggle panels buttons -->
      <button *ngIf="!selectedActif"
              mat-raised-button 
              [color]="isFilterPanelVisible ? 'primary' : 'basic'"
              (click)="toggleFilterPanel()"
              matTooltip="Afficher/Masquer les filtres">
        <mat-icon>filter_list</mat-icon>
        Filtres
      </button>
      
      <button mat-raised-button 
              [color]="isLegendVisible ? 'accent' : 'basic'"
              (click)="toggleLegend()"
              matTooltip="Afficher/Masquer la lÃ©gende">
        <mat-icon>legend_toggle</mat-icon>
        LÃ©gende
      </button>
      
      <!-- Map navigation buttons -->
      <button mat-raised-button 
              color="primary" 
              (click)="centerOnTanger()"
              matTooltip="Centrer sur Tanger">
        <mat-icon>my_location</mat-icon>
        Tanger
      </button>
      
      <button mat-raised-button 
              color="accent"
              (click)="zoomToActifs()"
              [disabled]="isLoading"
              matTooltip="Voir tous les actifs">
        <mat-icon>zoom_out_map</mat-icon>
        Voir tout
      </button>
      
      <button mat-raised-button 
              (click)="refreshData()"
              [disabled]="isLoading"
              matTooltip="Actualiser les donnÃ©es">
        <mat-icon [class.rotating]="isLoading">refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <div class="map-wrapper">
    <!-- OpenLayers map container -->
    <div id="map" class="ol-map" [class.loading]="isLoading">
      
      <!-- Draggable Filter Panel -->
      <div *ngIf="!selectedActif && isFilterPanelVisible" 
           class="floating-panel filter-panel"
           cdkDrag
           cdkDragBoundary=".map-wrapper">
        <div class="panel-header" cdkDragHandle>
          <div class="panel-title">
            <mat-icon>filter_list</mat-icon>
            <h4>Filtres</h4>
          </div>
          <button mat-icon-button (click)="toggleFilterPanel()" matTooltip="Fermer">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <div class="panel-content">
          <!-- Base Map Selection -->
          <div class="filter-section">
            <label>Fond de carte</label>
            <mat-form-field appearance="outline" [subscriptSizing]="'dynamic'">
              <mat-select [(value)]="selectedBaseMap" (selectionChange)="onBaseMapChange()">
                <mat-option value="osm">OpenStreetMap</mat-option>
                <mat-option value="satellite">Satellite</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Ã‰tat Chips -->
          <div class="filter-section">
            <label>Ã‰tat des actifs</label>
            <div class="etat-chips">
              <mat-chip-listbox>
                <mat-chip-option *ngFor="let chip of etatChips" 
                                [selected]="chip.selected"
                                [style.background-color]="chip.selected ? chip.color : 'transparent'"
                                [style.color]="chip.selected ? 'white' : chip.color"
                                [style.border]="'2px solid ' + chip.color"
                                (click)="onChipToggle(chip.value)">
                  {{chip.label}} ({{chip.count}})
                </mat-chip-option>
              </mat-chip-listbox>
            </div>
          </div>

          <!-- Accordion for Sites and Zones -->
          <mat-accordion>
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>business</mat-icon>
                  Sites
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div class="checkbox-list">
                <mat-checkbox *ngFor="let filter of siteFilters"
                              [(ngModel)]="filter.checked"
                              (change)="onSiteFilterChange()">
                  {{filter.label}} ({{filter.count}})
                </mat-checkbox>
              </div>
            </mat-expansion-panel>

            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>place</mat-icon>
                  Zones
                </mat-panel-title>
              </mat-expansion-panel-header>
              <div class="checkbox-list">
                <mat-checkbox *ngFor="let filter of zoneFilters"
                              [(ngModel)]="filter.checked"
                              (change)="onZoneFilterChange()">
                  {{filter.label}} ({{filter.count}})
                </mat-checkbox>
              </div>
            </mat-expansion-panel>
          </mat-accordion>

         
        </div>
      </div>

      <!-- Draggable Legend Panel -->
      <div *ngIf="isLegendVisible" 
           class="floating-panel legend-panel"
           cdkDrag
           cdkDragBoundary=".map-wrapper">
        <div class="panel-header" cdkDragHandle>
          <div class="panel-title">
            <mat-icon>map</mat-icon>
            <h4>LÃ©gende</h4>
          </div>
          <button mat-icon-button (click)="toggleLegend()" matTooltip="Fermer">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        
        <div class="panel-content">
          <!-- Selected Actif Info -->
          <div *ngIf="selectedActif" class="selected-actif-info">
            <strong>ðŸŽ¯ {{selectedActif.nom}}</strong>
            <small>{{selectedActif.code}}</small>
          </div>
          
          <!-- Legend Items -->
          <div class="legend-items">
            <div *ngFor="let chip of etatChips" 
                 class="legend-item"
                 [class.disabled]="!chip.selected"
                 (click)="onLegendItemClick(chip.value)">
              <div class="legend-symbol" [style.background-color]="chip.color"></div>
              <span>{{chip.label}} ({{chip.count}})</span>
            </div>
          </div>
          
          <!-- Back Button -->
          <button *ngIf="selectedActif" 
                  mat-raised-button 
                  color="primary" 
                  class="back-btn"
                  (click)="goBackToList()">
            <mat-icon>arrow_back</mat-icon>
            Retour Ã  la liste
          </button>
        </div>
      </div>
    </div>

    <!-- Popup element for feature details -->
    <div #popup class="ol-popup">
      <a href="#" class="ol-popup-closer"></a>
      <div #popupContent></div>
    </div>
    
    <!-- Loading overlay -->
    <div *ngIf="isLoading" class="map-loading">
      <app-loading-spinner message="Chargement de la carte..."></app-loading-spinner>
    </div>
    
    <!-- Error overlay -->
    <div *ngIf="error" class="map-error">
      <mat-icon>error</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="refreshData()">
        RÃ©essayer
      </button>
    </div>
  </div>
</div>