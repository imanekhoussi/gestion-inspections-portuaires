<div class="map-container">
  <div class="map-header">
    <button *ngIf="selectedActif" mat-raised-button color="primary" (click)="goBackToList()" matTooltip="Retour Ã  la carte">
      <mat-icon>arrow_back</mat-icon>
      Retour
    </button>
    <div class="map-controls">
      <button *ngIf="!selectedActif" mat-raised-button [color]="isFilterPanelVisible ? 'primary' : 'basic'" (click)="toggleFilterPanel()" matTooltip="Afficher/Masquer les filtres">
        <mat-icon>filter_list</mat-icon>
        Filtres
      </button>
      <button mat-raised-button [color]="isLegendVisible ? 'accent' : 'basic'" (click)="toggleLegend()" matTooltip="Afficher/Masquer la lÃ©gende">
        <mat-icon>legend_toggle</mat-icon>
        LÃ©gende
      </button>
      <button mat-raised-button color="primary" (click)="centerOnTanger()" matTooltip="Centrer sur Tanger">
        <mat-icon>my_location</mat-icon>
        Tanger
      </button>
      <button mat-raised-button color="accent" (click)="zoomToActifs()" [disabled]="isLoading" matTooltip="Voir tous les actifs">
        <mat-icon>zoom_out_map</mat-icon>
        Voir tout
      </button>
      <button mat-raised-button (click)="refreshData()" [disabled]="isLoading" matTooltip="Actualiser les donnÃ©es">
        <mat-icon [class.rotating]="isLoading">refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <div class="map-wrapper" #mapWrapper>
    <div id="map" class="ol-map" [class.loading]="isLoading">

      <div *ngIf="!selectedActif && isFilterPanelVisible" class="floating-panel filter-panel" cdkDrag [cdkDragBoundary]="dragBoundarySelector">
        <div class="panel-header" cdkDragHandle>
          <div class="panel-title">
            <mat-icon>filter_list</mat-icon>
            <h4>Filtres</h4>
          </div>
          <button mat-icon-button (click)="toggleFilterPanel()" matTooltip="Fermer"><mat-icon>close</mat-icon></button>
        </div>
        <div class="panel-content">
          <div class="filter-section">
            <label>Fond de carte</label>
            <mat-form-field appearance="outline" [subscriptSizing]="'dynamic'">
              <mat-select [(value)]="selectedBaseMap" (selectionChange)="onBaseMapChange()">
                <mat-option value="osm">OpenStreetMap</mat-option>
                <mat-option value="satellite">Satellite</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
          <div class="filter-section">
            <label>Ã‰tat des actifs</label>
            <mat-chip-listbox multiple="true" class="etat-chips">
              <mat-chip-option *ngFor="let chip of etatChips" [selected]="chip.selected" [style.background-color]="chip.selected ? chip.color : null" [style.color]="chip.selected ? 'white' : chip.color" [style.border-color]="chip.color" (click)="onChipToggle(chip.value)">
                {{chip.label}} ({{chip.count}})
              </mat-chip-option>
            </mat-chip-listbox>
          </div>
          <mat-accordion>
            <mat-expansion-panel>
              <mat-expansion-panel-header><mat-panel-title><mat-icon>business</mat-icon>Sites</mat-panel-title></mat-expansion-panel-header>
              <div class="checkbox-list">
                <mat-checkbox *ngFor="let filter of siteFilters" [(ngModel)]="filter.checked" (change)="onFilterChange()">
                  {{filter.label}} ({{filter.count}})
                </mat-checkbox>
              </div>
            </mat-expansion-panel>
            <mat-expansion-panel>
              <mat-expansion-panel-header><mat-panel-title><mat-icon>place</mat-icon>Zones</mat-panel-title></mat-expansion-panel-header>
              <div class="checkbox-list">
                <mat-checkbox *ngFor="let filter of zoneFilters" [(ngModel)]="filter.checked" (change)="onFilterChange()">
                  {{filter.label}} ({{filter.count}})
                </mat-checkbox>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </div>

      <div *ngIf="isLegendVisible" class="floating-panel legend-panel" cdkDrag [cdkDragBoundary]="dragBoundarySelector">
        <div class="panel-header" cdkDragHandle>
          <div class="panel-title">
            <mat-icon>map</mat-icon>
            <h4>LÃ©gende</h4>
          </div>
          <button mat-icon-button (click)="toggleLegend()" matTooltip="Fermer"><mat-icon>close</mat-icon></button>
        </div>
        <div class="panel-content">
          <div *ngIf="selectedActif" class="selected-actif-info">
            <strong>ðŸŽ¯ {{selectedActif.nom}}</strong>
            <small>{{selectedActif.code}}</small>
          </div>
          <div class="legend-items">
            <div *ngFor="let chip of etatChips" class="legend-item" [class.disabled]="!chip.selected" (click)="onChipToggle(chip.value)">
              <div class="legend-symbol" [style.background-color]="chip.color"></div>
              <span>{{chip.label}} ({{chip.count}})</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div #popup class="ol-popup">
      <a href="#" class="ol-popup-closer"></a>
      <div #popupContent></div>
    </div>
    
    <div *ngIf="isLoading" class="map-overlay"><app-loading-spinner message="Chargement des actifs..."></app-loading-spinner></div>
    <div *ngIf="error" class="map-overlay map-error">
      <mat-icon>error_outline</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="refreshData()">RÃ©essayer</button>
    </div>
  </div>
</div>