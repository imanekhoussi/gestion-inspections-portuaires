<form [formGroup]="inspectionForm" (ngSubmit)="onSubmit()">
  <h1 mat-dialog-title>
    <mat-icon>{{ isEditMode ? 'edit' : 'add_task' }}</mat-icon>
    {{ isEditMode ? 'Modifier l\'inspection' : 'Nouvelle inspection' }}
  </h1>

  <mat-dialog-content class="mat-typography">
    <mat-expansion-panel expanded="true" class="form-section">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>info</mat-icon>
          Informations générales
        </mat-panel-title>
      </mat-expansion-panel-header>
      
      <div class="form-grid">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Titre de l'inspection</mat-label>
          <input matInput formControlName="titre" placeholder="Ex: Contrôle sécurité Quai A">
          <mat-icon matSuffix>assignment</mat-icon>
          <mat-error *ngIf="inspectionForm.get('titre')?.invalid && inspectionForm.get('titre')?.touched">
            {{ getErrorMessage('titre') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Type d'inspection</mat-label>
          <mat-select formControlName="idType">
            <mat-option *ngFor="let type of typesInspection" [value]="type.id">
              {{ type.nom }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>rule</mat-icon>
          <mat-error *ngIf="inspectionForm.get('idType')?.invalid && inspectionForm.get('idType')?.touched">
            {{ getErrorMessage('idType') }}
          </mat-error>
        </mat-form-field>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel expanded="true" class="form-section">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>date_range</mat-icon>
          Période planifiée
        </mat-panel-title>
      </mat-expansion-panel-header>
      
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Date de début planifiée</mat-label>
          <input matInput [matDatepicker]="pickerDebutForm" formControlName="dateDebut">
          <mat-datepicker-toggle matSuffix [for]="pickerDebutForm"></mat-datepicker-toggle>
          <mat-datepicker #pickerDebutForm></mat-datepicker>
          <mat-error *ngIf="inspectionForm.get('dateDebut')?.invalid && inspectionForm.get('dateDebut')?.touched">
            {{ getErrorMessage('dateDebut') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date de fin planifiée</mat-label>
          <input matInput [matDatepicker]="pickerFinForm" formControlName="dateFin">
          <mat-datepicker-toggle matSuffix [for]="pickerFinForm"></mat-datepicker-toggle>
          <mat-datepicker #pickerFinForm></mat-datepicker>
           <mat-error *ngIf="inspectionForm.get('dateFin')?.invalid && inspectionForm.get('dateFin')?.touched">
            {{ getErrorMessage('dateFin') }}
          </mat-error>
        </mat-form-field>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel expanded="true" class="form-section">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>precision_manufacturing</mat-icon>
          Actifs à inspecter ({{ selection.selected.length }} sélectionné(s))
        </mat-panel-title>
      </mat-expansion-panel-header>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Choisir un groupe d'actifs</mat-label>
        <mat-select formControlName="idGroupe">
          <mat-option *ngFor="let groupe of groupes" [value]="groupe.id">
            {{ groupe.nom }}
          </mat-option>
        </mat-select>
        <mat-icon matSuffix>category</mat-icon>
        <mat-error *ngIf="inspectionForm.get('idGroupe')?.invalid && inspectionForm.get('idGroupe')?.touched">
          Veuillez sélectionner un groupe.
        </mat-error>
      </mat-form-field>
      
      <div *ngIf="inspectionForm.get('idGroupe')?.value" class="actifs-selection">
        <div class="table-container">
          <table mat-table [dataSource]="dataSource">

            <ng-container matColumnDef="select">
              <th mat-header-cell *matHeaderCellDef>
                <mat-checkbox (change)="$event ? masterToggle() : null"
                              [checked]="selection.hasValue() && isAllSelected()"
                              [indeterminate]="selection.hasValue() && !isAllSelected()"
                              aria-label="Select all assets">
                </mat-checkbox>
              </th>
              <td mat-cell *matCellDef="let row">
                <mat-checkbox (click)="$event.stopPropagation()"
                              (change)="$event ? selection.toggle(row) : null"
                              [checked]="selection.isSelected(row)"
                              [aria-label]="'Select asset ' + row.nom">
                </mat-checkbox>
              </td>
            </ng-container>

            <ng-container matColumnDef="nom">
              <th mat-header-cell *matHeaderCellDef> Nom </th>
              <td mat-cell *matCellDef="let actif"> {{actif.nom}} </td>
            </ng-container>

            <ng-container matColumnDef="code">
              <th mat-header-cell *matHeaderCellDef> Code </th>
              <td mat-cell *matCellDef="let actif"> {{actif.code}} </td>
            </ng-container>

            <ng-container matColumnDef="site">
              <th mat-header-cell *matHeaderCellDef> Site </th>
              <td mat-cell *matCellDef="let actif"> {{actif.site}} </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="selection.toggle(row)"></tr>
            
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell" colspan="4">Aucun actif trouvé pour ce groupe.</td>
            </tr>
          </table>
        </div>
        <mat-error *ngIf="inspectionForm.get('actifIds')?.invalid && inspectionForm.get('actifIds')?.touched">
          Veuillez sélectionner au moins un actif.
        </mat-error>
      </div>
    </mat-expansion-panel>

    <mat-expansion-panel class="form-section">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>comment</mat-icon>
          Commentaire (optionnel)
        </mat-panel-title>
      </mat-expansion-panel-header>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Commentaire ou instructions</mat-label>
        <textarea matInput formControlName="commentaire" rows="3"></textarea>
      </mat-form-field>
    </mat-expansion-panel>

  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button type="button" (click)="onCancel()">
      <mat-icon>cancel</mat-icon>
      Annuler
    </button>
    <button mat-raised-button color="primary" type="submit" [disabled]="inspectionForm.invalid">
      <mat-icon>{{ isEditMode ? 'save' : 'add_task' }}</mat-icon>
      {{ isEditMode ? 'Enregistrer' : 'Créer' }}
    </button>
  </mat-dialog-actions>
</form>