<div class="admin-section">
  <div class="section-header">
    <div class="header-content">
      <h1>
        <mat-icon class="header-icon">assignment</mat-icon>
        <span>Gestion des Inspections</span>
      </h1>
      <p class="header-description">Création, planification et suivi des inspections portuaires</p>
    </div>
    <div class="header-actions">
      <button
        mat-stroked-button
        color="primary"
        routerLink="/admin/types-inspection"
        matTooltip="Gérer les types d'inspection"
        class="action-button">
        <mat-icon>rule</mat-icon>
        <span>Types d'inspection</span>
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="openAddDialog()"
        class="add-button"
        matTooltip="Créer une nouvelle inspection">
        <mat-icon>add_task</mat-icon>
        <span>Nouvelle inspection</span>
      </button>
    </div>
  </div>

  <div *ngIf="isLoading && dataSource.data.length === 0" class="loading-container">
    <div class="loading-content">
      <mat-spinner diameter="50"></mat-spinner>
      <p class="loading-text">Chargement des inspections...</p>
      <p class="loading-subtext">Veuillez patienter</p>
    </div>
  </div>

  <div *ngIf="!isLoading || dataSource.data.length > 0" class="content-container">
    <div class="stats-section">
      <h2 class="section-title">
        <mat-icon>analytics</mat-icon>
        Aperçu des statistiques
      </h2>
      <div class="stats-grid">
        <mat-card
          class="stat-card"
          *ngFor="let etatOption of etatOptions; trackBy: trackByEtat"
          [class.stat-card-highlighted]="getStatsByEtat(etatOption.value) > 0">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon-container" [style.background-color]="etatOption.color + '20'">
                <mat-icon
                  class="stat-icon"
                  [style.color]="etatOption.color">
                  {{ etatOption.icon }}
                </mat-icon>
              </div>
              <div class="stat-info">
                <h3 class="stat-number">{{ getStatsByEtat(etatOption.value) }}</h3>
                <p class="stat-label">{{ etatOption.label }}</p>
                <div class="stat-progress" *ngIf="totalInspections > 0">
                  <div
                    class="stat-progress-bar"
                    [style.width.%]="(getStatsByEtat(etatOption.value) / totalInspections) * 100"
                    [style.background-color]="etatOption.color">
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <mat-card class="filters-card">
      <mat-card-header>
        <mat-card-title class="filters-title">
          <mat-icon>filter_list</mat-icon>
          <span>Filtres et recherche</span>
          <mat-chip
            *ngIf="hasActiveFilters()"
            class="filters-count-chip"
            color="primary">
            {{ getActiveFiltersCount() }} filtre(s) actif(s)
          </mat-chip>
        </mat-card-title>
        <mat-card-subtitle *ngIf="hasActiveFilters()">
          Filtres appliqués : {{ getActiveFiltersText() }}
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="filters-grid">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>Rechercher une inspection</mat-label>
            <input
              matInput
              (input)="onSearchChange($event)"
              placeholder="Titre, type, inspecteur..."
              [(ngModel)]="filtres.search"
              autocomplete="off">
            <mat-icon matSuffix>search</mat-icon>
            <mat-hint>Recherche dans le titre, type et inspecteur</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Type d'inspection</mat-label>
            <mat-select
              [(ngModel)]="filtres.idType"
              (selectionChange)="applyFilters()"
              placeholder="Sélectionner un type">
              <mat-option [value]="undefined">
                <mat-icon>all_inclusive</mat-icon>
                Tous les types
              </mat-option>
              <mat-optgroup label="Types disponibles">
                <mat-option
                  *ngFor="let type of typesInspection; trackBy: trackByTypeId"
                  [value]="type.id">
                  <span class="option-content">
                    <mat-icon>rule</mat-icon>
                    {{ type.nom }}
                  </span>
                </mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>État de l'inspection</mat-label>
            <mat-select
              [(ngModel)]="filtres.etat"
              (selectionChange)="applyFilters()"
              placeholder="Sélectionner un état">
              <mat-option [value]="undefined">
                <mat-icon>all_inclusive</mat-icon>
                Tous les états
              </mat-option>
              <mat-optgroup label="États disponibles">
                <mat-option
                  *ngFor="let etat of etatOptions; trackBy: trackByEtatValue"
                  [value]="etat.value">
                  <span class="option-content">
                    <mat-icon [style.color]="etat.color">{{ etat.icon }}</mat-icon>
                    {{ etat.label }}
                  </span>
                </mat-option>
              </mat-optgroup>
            </mat-select>
          </mat-form-field>

          <div class="filter-actions">
            <button
              mat-stroked-button
              (click)="clearFilters()"
              class="clear-filters-btn"
              [disabled]="!hasActiveFilters()"
              matTooltip="Supprimer tous les filtres">
              <mat-icon>clear_all</mat-icon>
              <span>Effacer les filtres</span>
            </button>
            <button
              mat-stroked-button
              (click)="exportInspections()"
              class="export-btn"
              matTooltip="Exporter la liste des inspections">
              <mat-icon>download</mat-icon>
              <span>Exporter</span>
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title class="table-title">
          <mat-icon>list</mat-icon>
          <span>Liste des inspections</span>
          <mat-chip class="total-count-chip" color="accent">
            {{ totalInspections }} inspection(s)
          </mat-chip>
        </mat-card-title>
        <mat-card-subtitle *ngIf="dataSource.data.length !== totalInspections">
          Affichage de {{ dataSource.data.length }} sur {{ totalInspections }} inspections
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="dataSource.data.length > 0 || isLoading; else emptyState" class="table-container">
          <div class="table-toolbar">
            <div class="table-info" *ngIf="paginator">
              <span class="results-info">
                {{ paginator.pageIndex * paginator.pageSize + 1 }} -
                {{ Math.min((paginator.pageIndex + 1) * paginator.pageSize, totalInspections) }}
                sur {{ totalInspections }} inspections
              </span>
            </div>
            <div class="table-actions">
              <button
                mat-icon-button
                (click)="refreshData()"
                matTooltip="Actualiser les données"
                [disabled]="isLoading">
                <mat-icon [class.spin]="isLoading">refresh</mat-icon>
              </button>
              <button
                mat-icon-button
                [matMenuTriggerFor]="columnsMenu"
                matTooltip="Personnaliser les colonnes">
                <mat-icon>view_column</mat-icon>
              </button>
            </div>
          </div>

          <div class="table-wrapper">
  <table mat-table [dataSource]="dataSource" matSort class="inspections-table">
    <ng-container matColumnDef="titre">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span class="header-content">
          <mat-icon>title</mat-icon>
          Inspection
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="titre-cell">
        <div class="cell-content">
          <strong class="inspection-title">{{ inspection.titre }}</strong>
          <small class="inspection-id">ID: {{ inspection.id }}</small>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="type">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span class="header-content">
          <mat-icon>category</mat-icon>
          Type
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="type-cell">
        <mat-chip class="type-chip" color="primary">
          <mat-icon>rule</mat-icon>
          {{ getTypeNom(inspection.typeInspection) }}
        </mat-chip>
      </td>
    </ng-container>

    <ng-container matColumnDef="periode">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span class="header-content">
          <mat-icon>date_range</mat-icon>
          Période
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="periode-cell">
        <div class="periode-content">
          <div class="date-range">
            <span class="date-start">{{ inspection.dateDebut | date:'dd/MM/yy' }}</span>
            <mat-icon class="date-separator">arrow_forward</mat-icon>
            <span class="date-end">{{ inspection.dateFin | date:'dd/MM/yy' }}</span>
          </div>
          <small class="duration">{{ getDuration(inspection.dateDebut, inspection.dateFin) }}</small>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="etat">
      <th mat-header-cell *matHeaderCellDef mat-sort-header>
        <span class="header-content">
          <mat-icon>flag</mat-icon>
          État
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="etat-cell">
        <mat-chip
          class="etat-chip"
          [style.background-color]="getEtatOption(inspection.etat).color"
          [style.color]="'white'">
          <mat-icon>{{ getEtatOption(inspection.etat).icon }}</mat-icon>
          {{ getEtatOption(inspection.etat).label }}
        </mat-chip>
      </td>
    </ng-container>

    <ng-container matColumnDef="actifs">
      <th mat-header-cell *matHeaderCellDef>
        <span class="header-content">
          <mat-icon>inventory</mat-icon>
          Actifs
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="actifs-cell">
        <div class="actifs-content" *ngIf="inspection.actifs?.length > 0; else noActifs">
          <mat-chip class="actifs-count-chip" color="accent">
            <mat-icon>inventory</mat-icon>
            {{ inspection.actifs.length }}
          </mat-chip>
          <button
            mat-icon-button
            (click)="showActifsDetails(inspection.actifs, $event)"
            matTooltip="Voir les détails des actifs"
            class="actifs-details-btn">
            <mat-icon>info</mat-icon>
          </button>
        </div>
        <ng-template #noActifs>
          <span class="no-actifs">Aucun actif</span>
        </ng-template>
      </td>
    </ng-container>

    <ng-container matColumnDef="inspecteur">
      <th mat-header-cell *matHeaderCellDef>
        <span class="header-content">
          <mat-icon>person</mat-icon>
          Inspecteur
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="inspecteur-cell">
        <div class="inspecteur-content">
          <mat-chip class="inspecteur-chip">
            <mat-icon>person</mat-icon>
            {{ getInspecteurNom(inspection.createur) }}
          </mat-chip>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>
        <span class="header-content">
          <mat-icon>settings</mat-icon>
          Actions
        </span>
      </th>
      <td mat-cell *matCellDef="let inspection" class="actions-cell">
        <div class="action-buttons">
          <button
            mat-icon-button
            color="primary"
            (click)="openEditDialog(inspection)"
            matTooltip="Modifier l'inspection"
            class="action-btn edit-btn">
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="duplicateInspection(inspection)"
            matTooltip="Dupliquer l'inspection"
            class="action-btn duplicate-btn">
            <mat-icon>content_copy</mat-icon>
          </button>
          <button
            mat-icon-button
            [matMenuTriggerFor]="actionMenu"
            matTooltip="Plus d'actions"
            class="action-btn more-btn">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #actionMenu="matMenu">
            <button mat-menu-item (click)="viewInspectionDetails(inspection)">
              <mat-icon>visibility</mat-icon>
              <span>Voir les détails</span>
            </button>
            <button mat-menu-item (click)="exportInspection(inspection)">
              <mat-icon>download</mat-icon>
              <span>Exporter</span>
            </button>
            <mat-divider></mat-divider>
            <button
              mat-menu-item
              (click)="deleteInspection(inspection)"
              class="delete-menu-item">
              <mat-icon color="warn">delete</mat-icon>
              <span>Supprimer</span>
            </button>
          </mat-menu>
        </div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns;"
      class="table-row"
      [class.row-highlighted]="isRowHighlighted(row)">
    </tr>
  </table>
</div>

          <div class="pagination-container">
            <mat-paginator
              [length]="totalInspections"
              [pageSize]="pageSize"
              [pageSizeOptions]="[5, 10, 25, 50, 100]"
              showFirstLastButtons
              class="custom-paginator">
            </mat-paginator>
          </div>
        </div>

        <ng-template #emptyState>
          <div class="empty-state">
            <div class="empty-icon-container">
              <mat-icon class="empty-icon">search_off</mat-icon>
            </div>
            <h3 class="empty-title">Aucune inspection trouvée</h3>
            <p class="empty-description" *ngIf="hasActiveFilters(); else noInspectionsMessage">
              Aucune inspection ne correspond à vos critères de recherche.
              <br>Essayez d'ajuster vos filtres ou
              <button mat-button color="primary" (click)="clearFilters()">supprimez-les</button>.
            </p>
            <ng-template #noInspectionsMessage>
              <p class="empty-description">
                Vous n'avez encore créé aucune inspection.
                <br>Commencez par
                <button mat-button color="primary" (click)="openAddDialog()">créer votre première inspection</button>.
              </p>
            </ng-template>
            <div class="empty-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="openAddDialog()"
                class="empty-action-btn">
                <mat-icon>add_task</mat-icon>
                Créer une inspection
              </button>
              <button
                mat-stroked-button
                routerLink="/admin/types-inspection"
                class="empty-action-btn">
                <mat-icon>rule</mat-icon>
                Gérer les types
              </button>
            </div>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>
  </div>

  <mat-menu #columnsMenu="matMenu">
    <div class="columns-menu-content">
      <h4 class="menu-title">Colonnes à afficher</h4>
      <mat-selection-list [(ngModel)]="visibleColumns" (selectionChange)="updateDisplayedColumns()">
        <mat-list-option
          *ngFor="let column of availableColumns"
          [value]="column.key"
          [selected]="displayedColumns.includes(column.key)">
          <mat-icon matListItemIcon>{{ column.icon }}</mat-icon>
          {{ column.label }}
        </mat-list-option>
      </mat-selection-list>
    </div>
  </mat-menu>
</div>