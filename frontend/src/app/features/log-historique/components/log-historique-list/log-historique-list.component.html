
<div class="log-historique-container">
  <div class="header">
    <div class="title-section">
      <h2 class="title">
        <mat-icon>history</mat-icon>
        <span *ngIf="!inspectionIdSignal()">Historique des Logs</span>
        <span *ngIf="inspectionIdSignal()">Historique de l'Inspection #{{ inspectionIdSignal() }}</span>
      </h2>
      
      <div class="results-indicator" *ngIf="filteredCount() !== totalLogs()">
        <span class="results-count">
          {{ filteredCount() }} / {{ totalLogs() }} logs
        </span>
      </div>
    </div>

    <div class="header-actions" *ngIf="showActions">
      <button mat-stroked-button (click)="refreshData()" [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
      
      <button mat-stroked-button (click)="toggleStats()">
        <mat-icon>analytics</mat-icon>
        Voir Statistiques
      </button>

     

      <button mat-stroked-button [matMenuTriggerFor]="activiteMenu">
        <mat-icon>schedule</mat-icon>
        Activité Récente
      </button>
      <mat-menu #activiteMenu="matMenu">
        <button mat-menu-item (click)="loadActiviteRecente(1)">Dernière heure</button>
        <button mat-menu-item (click)="loadActiviteRecente(24)">Dernières 24h</button>
        <button mat-menu-item (click)="loadActiviteRecente(168)">Dernière semaine</button>
      </mat-menu>


      <mat-menu #filterMenu="matMenu" class="filter-menu">
        <!-- Filtre par utilisateur -->
        <div class="filter-section">
          <div class="filter-header">
            <mat-icon>person</mat-icon>
            <span>Par Utilisateur</span>
          </div>
          <div class="filter-search">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput 
                     [(ngModel)]="userSearchText" 
                     placeholder="Nom ou email de l'utilisateur"
                     (keyup.enter)="applyUserFilter()">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            <div class="filter-buttons">
              <button mat-button color="primary" (click)="applyUserFilter()" [disabled]="!userSearchText.trim()">
                Appliquer
              </button>
              <button mat-button (click)="clearUserFilter()" *ngIf="userSearchText">
                Effacer
              </button>
            </div>
          </div>
        </div>

        <!-- Filtre par inspection -->
        <div class="filter-section" *ngIf="!inspectionIdSignal()">
          <div class="filter-header">
            <mat-icon>assignment</mat-icon>
            <span>Par Inspection</span>
          </div>
          <div class="filter-search">
            <mat-form-field appearance="outline" class="compact-field">
              <input matInput 
                     [(ngModel)]="inspectionSearchText" 
                     placeholder="Nom ou ID de l'inspection"
                     (keyup.enter)="applyInspectionFilter()">
              <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            <div class="filter-buttons">
              <button mat-button color="primary" (click)="applyInspectionFilter()" [disabled]="!inspectionSearchText.trim()">
                Appliquer
              </button>
              <button mat-button (click)="clearInspectionFilter()" *ngIf="inspectionSearchText">
                Effacer
              </button>
            </div>
          </div>
        </div>

        <!-- Reset filtres -->
        <button mat-menu-item (click)="resetFilters()">
          <mat-icon>clear_all</mat-icon>
          <span>Réinitialiser les filtres</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Barre de recherche (du code actuel) -->
  <div class="search-section">
    <form [formGroup]="searchForm" class="search-form">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Rechercher dans l'historique</mat-label>
        <input matInput 
               formControlName="searchText" 
               placeholder="Rechercher par nom, inspection, commentaire...">
        <mat-icon matSuffix>search</mat-icon>
        <button mat-icon-button matSuffix 
                *ngIf="searchForm.get('searchText')?.value"
                (click)="clearSearch()"
                type="button">
          <mat-icon>clear</mat-icon>
        </button>
      </mat-form-field>
    </form>
  </div>

 
  <!-- Message d'erreur -->
  <mat-card *ngIf="error()" class="error-card">
    <mat-card-content>
      <div class="error-message">
        <mat-icon color="warn">error</mat-icon>
        <span>{{ error() }}</span>
        <button mat-button color="primary" (click)="refreshData()">
          Réessayer
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Résumé des résultats (seulement si filtrés) -->
  <div class="results-summary" *ngIf="filteredCount() !== totalLogs() && !loading()">
    <mat-icon>info</mat-icon>
    <span>
      {{ filteredCount() }} résultat(s) affiché(s) sur {{ totalLogs() }} log(s) au total
    </span>
  </div>

  <!-- Tableau des logs -->
  <mat-card class="table-card">
    <!-- Indicateur de chargement -->
    <mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="logs-table">
          <!-- LIGNE DES EN-TÊTES -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          
          <!-- Colonne Date -->
          <ng-container matColumnDef="dateIntervention">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
            <td mat-cell *matCellDef="let log">
              <div class="date-cell">
                <span class="date">{{ formatDate(log.dateIntervention) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Intervenant -->
          <ng-container matColumnDef="intervenant">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Intervenant</th>
            <td mat-cell *matCellDef="let log">
              <div class="user-cell" *ngIf="log.intervenant">
                <mat-icon class="user-icon">person</mat-icon>
                <div class="user-info">
                  <span class="user-name">
                    {{ log.intervenant.nom }} {{ log.intervenant.prenom }}
                  </span>
                  <span class="user-email">{{ log.intervenant.email }}</span>
                </div>
              </div>
              <span *ngIf="!log.intervenant" class="no-data">Non spécifié</span>
            </td>
          </ng-container>

          <!-- Colonne Inspection -->
          <ng-container matColumnDef="inspection">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Inspection</th>
            <td mat-cell *matCellDef="let log">
              <div class="inspection-cell" *ngIf="log.inspection">
                <span class="inspection-name">{{ log.inspection.titre }}</span>
                <span class="inspection-id">#{{ log.inspection.id }}</span>
              </div>
              <span *ngIf="!log.inspection" class="no-data">Non spécifiée</span>
            </td>
          </ng-container>

          <!-- Colonne Ancien État -->
          <ng-container matColumnDef="ancienEtat">
            <th mat-header-cell *matHeaderCellDef>Ancien État</th>
            <td mat-cell *matCellDef="let log">
              <div class="etat-container">
                <span *ngIf="log.ancienEtat" 
                      [class]="getEtatBadgeClass(log.ancienEtat)"
                      [attr.data-priority]="getLogPriority(log)">
                  <mat-icon class="etat-icon">
                    {{ formatEtatWithIcon(log.ancienEtat).icon }}
                  </mat-icon>
                  {{ formatEtatWithIcon(log.ancienEtat).text }}
                </span>
                <span *ngIf="!log.ancienEtat" class="nouveau-badge">
                  <mat-icon class="etat-icon">fiber_new</mat-icon>
                  Nouveau
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Nouvel État -->
          <ng-container matColumnDef="nouvelEtat">
            <th mat-header-cell *matHeaderCellDef>Nouvel État</th>
            <td mat-cell *matCellDef="let log">
              <div class="etat-container">
                <span *ngIf="log.nouvelEtat" 
                      [class]="getEtatBadgeClass(log.nouvelEtat)"
                      [attr.data-priority]="getLogPriority(log)">
                  <mat-icon class="etat-icon">
                    {{ formatEtatWithIcon(log.nouvelEtat).icon }}
                  </mat-icon>
                  {{ formatEtatWithIcon(log.nouvelEtat).text }}
                </span>
                <span *ngIf="!log.nouvelEtat" class="supprime-badge">
                  <mat-icon class="etat-icon">delete</mat-icon>
                  Supprimé
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Commentaire -->
          <ng-container matColumnDef="commentaire">
            <th mat-header-cell *matHeaderCellDef>Commentaire</th>
            <td mat-cell *matCellDef="let log">
              <div class="commentaire-cell">
                <span *ngIf="log.commentaire" 
                      class="commentaire-text"
                      [title]="log.commentaire">
                  {{ log.commentaire.length > 50 ? (log.commentaire | slice:0:50) + '...' : log.commentaire }}
                </span>
                <span *ngIf="!log.commentaire" class="no-data">Aucun commentaire</span>
              </div>
            </td>
          </ng-container>

          <!-- Colonne Actions (FONCTIONNELLES) -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let log">
              <div class="actions-cell">
                <!-- Bouton Détails - FONCTIONNEL avec dialog -->
                <button mat-icon-button 
                        [class]="getActionButtonClass('details')"
                        [matTooltip]="'Voir détails du log'" 
                        (click)="viewDetails(log)"
                        [attr.aria-label]="'Voir détails du log ' + log.id">
                  <mat-icon>visibility</mat-icon>
                </button>
                
                <!-- Bouton Historique Inspection - FONCTIONNEL -->
                <button mat-icon-button 
                        *ngIf="log.inspection && !inspectionIdSignal()"
                        [class]="getActionButtonClass('history')"
                        [matTooltip]="'Voir historique de l\'inspection'" 
                        (click)="viewInspectionHistory(log.inspection.id)"
                        [attr.aria-label]="'Voir historique de l\'inspection ' + log.inspection.titre">
                  <mat-icon>history</mat-icon>
                </button>
                
                <!-- Bouton Activité Utilisateur - FONCTIONNEL -->
                <button mat-icon-button 
                        *ngIf="log.intervenant"
                        [class]="getActionButtonClass('user')"
                        [matTooltip]="'Voir activité de l\'utilisateur'" 
                        (click)="viewUserActivity(log.intervenant.id)"
                        [attr.aria-label]="'Voir activité de ' + log.intervenant.nom + ' ' + log.intervenant.prenom">
                  <mat-icon>person_search</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <!-- Lignes de données -->
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
              class="log-row"
              [class.highlight-row]="shouldHighlightRow(row)"
              [attr.data-log-type]="getLogTypeClass(row)"
              [attr.data-priority]="getLogPriority(row)">
            <div class="log-type-indicator" 
                 [class]="getLogTypeClass(row)">
            </div>
          </tr>
        </table>

        <!-- Message si aucune donnée -->
        <div *ngIf="!loading() && filteredCount() === 0" class="no-data-message">
          <mat-icon>{{ totalLogs() === 0 ? 'inbox' : 'search_off' }}</mat-icon>
          <h3>
            {{ totalLogs() === 0 ? 'Aucun log trouvé' : 'Aucun résultat' }}
          </h3>
          <p>
            {{ totalLogs() === 0 
               ? 'Il n\'y a pas encore de logs dans le système.' 
               : 'Aucun log ne correspond aux critères de recherche.' 
            }}
          </p>
          <button mat-stroked-button *ngIf="totalLogs() > 0" (click)="resetFilters()">
            <mat-icon>clear_all</mat-icon>
            Réinitialiser les filtres
          </button>
        </div>
      </div>

      <!-- Paginateur -->
      <mat-paginator 
        [pageSizeOptions]="[10, 25, 50, 100]"
        showFirstLastButtons
        aria-label="Sélectionner une page de logs">
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>