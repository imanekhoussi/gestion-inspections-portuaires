<!-- src/app/features/log-historique/components/log-inspection-history/log-inspection-history.component.html -->

<div class="inspection-history-container">
  
  <!-- En-tête -->
  <div class="header">
    <div class="title-section">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="title">
        <mat-icon>timeline</mat-icon>
        Historique de l'inspection
        <span class="inspection-id" *ngIf="inspectionId()">#{{ inspectionId() }}</span>
      </h2>
    </div>
    
    <div class="header-actions">
      <button mat-stroked-button (click)="refreshData()" [disabled]="loading()">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Indicateur de chargement -->
  <mat-progress-bar *ngIf="loading()" mode="indeterminate"></mat-progress-bar>

  <!-- Message d'erreur -->
  <mat-card *ngIf="error()" class="error-card">
    <mat-card-content>
      <div class="error-message">
        <mat-icon color="warn">error</mat-icon>
        <span>{{ error() }}</span>
        <button mat-button color="primary" (click)="refreshData()">
          Réessayer
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Timeline des logs -->
  <div class="timeline-container" *ngIf="!loading() && logs().length > 0">
    
    <!-- Statistiques rapides -->
    <mat-card class="stats-card">
      <mat-card-content>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-number">{{ logs().length }}</span>
            <span class="stat-label">Actions totales</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getUniqueIntervenants() }}</span>
            <span class="stat-label">Intervenants</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getDurationDays() }}</span>
            <span class="stat-label">Jours d'activité</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Timeline -->
    <div class="timeline">
      <div class="timeline-item" 
           *ngFor="let log of logs(); let first = first; let last = last"
           [class.first]="first"
           [class.last]="last">
        
        <div class="timeline-marker">
          <div class="marker-dot" [ngClass]="getMarkerClass(log)">
            <mat-icon>{{ getMarkerIcon(log) }}</mat-icon>
          </div>
          <div class="timeline-line" *ngIf="!last"></div>
        </div>

        <div class="timeline-content">
          <mat-card class="log-card">
            <mat-card-header>
              <div class="log-header">
                <div class="log-date">
                  {{ formatDate(log.dateIntervention) }}
                </div>
                <div class="log-badges">
                  <mat-chip *ngIf="log.ancienEtat" 
                           [ngClass]="getEtatBadgeClass(log.ancienEtat)">
                    {{ log.ancienEtat }}
                  </mat-chip>
                  <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                  <mat-chip *ngIf="log.nouvelEtat" 
                           [ngClass]="getEtatBadgeClass(log.nouvelEtat)">
                    {{ log.nouvelEtat }}
                  </mat-chip>
                  <mat-chip *ngIf="!log.ancienEtat" class="nouveau-chip">
                    Création
                  </mat-chip>
                  <mat-chip *ngIf="!log.nouvelEtat" class="supprime-chip">
                    Suppression
                  </mat-chip>
                </div>
              </div>
            </mat-card-header>
            
            <mat-card-content>
              <div class="log-details">
                
                <!-- Intervenant -->
                <div class="detail-row" *ngIf="log.intervenant">
                  <mat-icon class="detail-icon">person</mat-icon>
                  <div class="detail-content">
                    <span class="detail-label">Intervenant</span>
                    <span class="detail-value">
                      {{ log.intervenant.nom }} {{ log.intervenant.prenom }}
                    </span>
                  </div>
                </div>

                <!-- Commentaire -->
                <div class="detail-row" *ngIf="log.commentaire">
                  <mat-icon class="detail-icon">comment</mat-icon>
                  <div class="detail-content">
                    <span class="detail-label">Commentaire</span>
                    <span class="detail-value">{{ log.commentaire }}</span>
                  </div>
                </div>

              </div>
            </mat-card-content>

            <mat-card-actions>
              <button mat-button 
                      *ngIf="log.intervenant"
                      (click)="viewUserActivity(log.intervenant.id)"
                      matTooltip="Voir l'activité de cet utilisateur">
                <mat-icon>person_search</mat-icon>
                Activité utilisateur
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>
    </div>
  </div>

  <!-- Message si aucune donnée -->
  <div *ngIf="!loading() && logs().length === 0" class="no-data-message">
    <mat-icon>timeline</mat-icon>
    <h3>Aucun historique trouvé</h3>
    <p>Cette inspection n'a pas encore d'historique d'actions.</p>
  </div>

</div>