<div class="modern-dashboard">
  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="title-section">
        <h1>Tableau de Bord des Inspections</h1>
        <p class="subtitle">Suivi et analyse en temps réel</p>
      </div>
      
      <div class="header-actions">
        <button
          *ngIf="isAdmin()"
          mat-stroked-button
          class="admin-btn"
          (click)="goToAdminInterface()"
        >
          <mat-icon>admin_panel_settings</mat-icon>
          Administration
        </button>
        
        <button
          mat-mini-fab
          color="primary"
          (click)="refreshData()"
          [disabled]="isLoading"
          matTooltip="Actualiser"
        >
          <mat-icon [class.rotating]="isLoading">refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-overlay">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des données...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <mat-icon>error_outline</mat-icon>
    <h3>Erreur de chargement</h3>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="refreshData()">
      Réessayer
    </button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error" class="dashboard-content">
    
    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card primary">
        <div class="kpi-icon">
          <mat-icon>assessment</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ kpis?.totalInspections || 0 }}</span>
          <span class="kpi-label">Total Inspections</span>
        </div>
      </div>

      <div class="kpi-card warning">
        <div class="kpi-icon">
          <mat-icon>schedule</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ kpis?.inspectionsPlanifiees || 0 }}</span>
          <span class="kpi-label">Planifiées</span>
        </div>
      </div>

      <div class="kpi-card info">
        <div class="kpi-icon">
          <mat-icon>play_circle</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ kpis?.inspectionsEnCours || 0 }}</span>
          <span class="kpi-label">En Cours</span>
        </div>
      </div>

      <div class="kpi-card secondary">
        <div class="kpi-icon">
          <mat-icon>check_circle_outline</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ kpis?.inspectionsCloturees || 0 }}</span>
          <span class="kpi-label">Clôturées</span>
        </div>
      </div>

      <div class="kpi-card success">
        <div class="kpi-icon">
          <mat-icon>verified</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ kpis?.inspectionsValidees || 0 }}</span>
          <span class="kpi-label">Validées</span>
        </div>
      </div>

      <div class="kpi-card accent">
        <div class="kpi-icon">
          <mat-icon>location_on</mat-icon>
        </div>
        <div class="kpi-info">
          <span class="kpi-value">{{ totalAssets }}</span>
          <span class="kpi-label">Actifs Totaux</span>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      
      <!-- Left Column -->
      <div class="left-column">
        
        <!-- Completion Rate Card -->
        <div class="stat-card">
          <div class="card-header">
            <h3>
              <mat-icon>trending_up</mat-icon>
              Taux de Complétion
            </h3>
          </div>
          <div class="card-body">
            <div class="completion-circle">
              <svg viewBox="0 0 200 200">
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#e5e7eb"
                  stroke-width="20"
                />
                <circle
                  cx="100"
                  cy="100"
                  r="80"
                  fill="none"
                  stroke="#10b981"
                  stroke-width="20"
                  [attr.stroke-dasharray]="(2 * 3.14159 * 80)"
                  [attr.stroke-dashoffset]="(2 * 3.14159 * 80) * (1 - getInspectionCompletionRate() / 100)"
                  transform="rotate(-90 100 100)"
                  stroke-linecap="round"
                />
              </svg>
              <div class="completion-text">
                <span class="percentage">{{ getInspectionCompletionRate() }}%</span>
                <span class="label">Validées</span>
              </div>
            </div>
            <div class="completion-details">
              <div class="detail-row">
                <span class="detail-label">Total</span>
                <span class="detail-value">{{ kpis?.totalInspections || 0 }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Validées</span>
                <span class="detail-value success">{{ kpis?.inspectionsValidees || 0 }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Restantes</span>
                <span class="detail-value warning">{{ (kpis?.totalInspections || 0) - (kpis?.inspectionsValidees || 0) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Condition Distribution - Only 3 conditions -->
        <div class="stat-card">
          <div class="card-header">
            <h3>
              <mat-icon>analytics</mat-icon>
              État des Actifs
            </h3>
          </div>
          <div class="card-body">
            <div *ngFor="let item of getValidConditionIndices()" class="condition-item">
              <div class="condition-header">
                <div class="condition-label">
                  <mat-icon [style.color]="conditionLabels[item].color">
                    {{ conditionLabels[item].icon }}
                  </mat-icon>
                  <span>{{ conditionLabels[item].label }}</span>
                </div>
                <div class="condition-stats">
                  <span class="count">{{ assetsByCondition[item] || 0 }}</span>
                  <span class="percentage">{{ getConditionPercentage(item) }}%</span>
                </div>
              </div>
              <div class="progress-bar">
                <div 
                  class="progress-fill" 
                  [style.width.%]="getConditionPercentage(item)"
                  [style.background-color]="conditionLabels[item].color"
                ></div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="right-column">
        
        <!-- Chart Card -->
        <div class="stat-card chart-card">
          <div class="card-header">
            <h3>
              <mat-icon>pie_chart</mat-icon>
              Répartition par État
            </h3>
          </div>
          <div class="card-body">
            <div *ngIf="isLoadingStats" class="loading-container">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <div *ngIf="errorStats && !isLoadingStats" class="error-container">
              <mat-icon>error_outline</mat-icon>
              <p>{{ errorStats }}</p>
            </div>

            <div *ngIf="!isLoadingStats && !errorStats && pieChartData.length > 0" class="chart-wrapper">
              <ngx-charts-pie-chart
                [results]="pieChartData"
                [scheme]="colorScheme"
                [legend]="true"
                [labels]="true"
                [doughnut]="true"
                [explodeSlices]="false"
                [gradient]="true"
                [tooltipDisabled]="false">
              </ngx-charts-pie-chart>
            </div>

            <div *ngIf="!isLoadingStats && !errorStats && pieChartData.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>Aucune donnée disponible</p>
            </div>
          </div>
        </div>

        <!-- Zone Statistics Card - NEW -->
        <div class="stat-card">
          <div class="card-header">
            <h3>
              <mat-icon>map</mat-icon>
              Répartition par Site et Zone
            </h3>
          </div>
          <div class="card-body">
            <div *ngIf="isLoadingZones" class="loading-container" style="height: 200px;">
              <mat-spinner diameter="40"></mat-spinner>
            </div>

            <div *ngIf="!isLoadingZones && zoneStatistics.length === 0" class="no-data" style="height: 200px;">
              <mat-icon>info</mat-icon>
              <p>Aucune donnée disponible</p>
            </div>

            <div *ngIf="!isLoadingZones && zoneStatistics.length > 0" class="zone-list">
              <div *ngFor="let stat of zoneStatistics" class="zone-item">
                <div class="zone-header">
                  <div class="zone-name">
                    <mat-icon>location_city</mat-icon>
                    <span>{{ stat.site }} - {{ stat.zone }}</span>
                  </div>
                  <div class="zone-count">
                    {{ stat.count }} actifs
                  </div>
                </div>
                <div class="zone-details">
                  <div class="detail">
                    <mat-icon>business</mat-icon>
                    <span>Site: <strong>{{ stat.site }}</strong></span>
                  </div>
                  <div class="detail">
                    <mat-icon>room</mat-icon>
                    <span>Zone: <strong>{{ stat.zone }}</strong></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

  </div>
</div>